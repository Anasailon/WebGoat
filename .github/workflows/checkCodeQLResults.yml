# Check the last code scanning run and fail if there are open alerts left
name: "Check code scanning results"
on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "develop" ]

jobs:
  retrieveRecentCodeScanningResults:
    name: retrieveRecentCodeScanningResults
    runs-on: ubuntu-latest
    permissions:
      security-events: read
    steps:
    - name: Get the most recent code scanning alerts
      run: |
        echo "Get the most recent code scanning alerts"
        echo "GitHub repository:" ${{ github.repository }}
        echo "Access Token: " ${{ secrets.GITHUB_TOKEN }}
        CODE_SCANNING_RESULTS=$(curl -sSL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts")
        echo "$CODE_SCANNING_RESULTS" > code_scanning_results.json
        cat code_scanning_results.json
    - name: Check if there are open alerts and exit accordingly
      run: |
        echo “Check if there are open alerts and exit accordingly”
        jq '.alerts[] | select(.state == "open")' code_scanning_results.json
        if jq -e '.alerts | any(.state == "open")' code_scanning_results.json; then
          echo "Found open alerts. Failing the workflow."
          exit 1
        else
          echo "No open alerts found."
        fi
